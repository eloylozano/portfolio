---
import Title from "./Title.astro";
import { projects } from "../data/projects.js";
import { t } from "../i18n";

const lang =
  Astro.request.headers.get("cookie")?.match(/preferredLang=([^;]+)/)?.[1] ||
  "es";

const sortedProjects = [...projects].sort((a, b) => {
  if (a.featured && !b.featured) return -1;
  if (!a.featured && b.featured) return 1;
  return 0;
});
---

<article
  class="bg-[#161512] my-8 sm:py-12 lg:my-16 text-white px-4 sm:px-8 lg:px-26 scroll-container"
>
  <Title
    class="text-center mb-6 sm:mb-8"
    text={t(lang, "pages.projects.title")}
  />

  <nav
    class="flex justify-center border-0 mx-auto font-medium mb-6 sm:mb-10 gap-4 sm:gap-8 lg:gap-26 px-4 sm:px-12 pb-2 text-xs sm:text-sm overflow-x-auto w-full max-w-full"
  >
    {
      /* Añadimos "ai" al array */
      ["all", "web", "app", "ai", "photo"].map((filter) => (
        <button
          class="filter-btn relative text-[#e9eeef] hover:text-white cursor-pointer transition duration-200 whitespace-nowrap px-2 sm:px-0 group"
          data-filter={filter}
        >
          {t(
            lang,
            `pages.projects.nav.${
              filter === "web"
                ? "design"
                : filter === "app"
                  ? "webApp"
                  : filter === "ai"
                    ? "aiBigData"
                    : filter === "photo"
                      ? "photos"
                      : "all"
            }`
          )}
          <span class="active-indicator absolute left-1/2 -bottom-2 -translate-x-1/2 h-0.5 bg-[#daa032] transition-all duration-300 w-0 opacity-0 group-hover:w-1/2 group-hover:opacity-50" />
        </button>
      ))
    }
  </nav>
  <div class="px-2 sm:px-0">
    <div
      id="project-grid"
      class="columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-3 sm:gap-4 space-y-3 sm:space-y-4"
    >
      {
        sortedProjects.map((project, i) => (
          <div
            class="project-item break-inside-avoid group relative h-full overflow-hidden shadow-lg transition-all duration-500 opacity-0"
            data-category={project.category}
            style={`animation-delay: ${i * 0.1}s`}
          >
            <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">
              {project.new && (
                <span class="bg-[#daa032] text-black text-[10px] font-bold px-2 py-0.5 uppercase">
                  New
                </span>
              )}
              {project.soon && (
                <span class="bg-white/20 backdrop-blur-md text-white text-[10px] font-bold px-2 py-0.5 uppercase">
                  {lang === "es" ? "Próximamente" : "Soon"}
                </span>
              )}
            </div>

            <a
              href={project.soon ? "#" : project.projectLink}
              class={project.soon ? "cursor-default" : ""}
            >
              <img
                src={project.img}
                alt={project.title}
                class="w-full h-auto max-h-70 sm:max-h-80 md:max-h-90 lg:max-h-105 object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
              />
            </a>

            <div class="absolute inset-0 bg-black/90 translate-y-full group-hover:translate-y-0 transition-transform duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] flex flex-col justify-center items-center p-6 text-center">
              <h3 class="text-lg font-bold mb-4">
                {project.title}{" "}
                {project.featured && <span class="text-[#daa032]">★</span>}
              </h3>
              <div class="flex flex-col gap-3 w-full">
                {!project.soon ? (
                  <>
                    {project.category !== "photo" && (
                      <a
                        href={project.demoLink}
                        target="_blank"
                        class="flex items-center justify-center gap-2 px-4 py-2 bg-white text-black text-sm font-semibold hover:bg-gray-200 transition-colors uppercase tracking-widest"
                      >
                        Visitar Web
                      </a>
                    )}
                    <a
                      href={project.projectLink}
                      class="px-4 py-2 bg-[#daa032] text-black text-sm font-semibold hover:bg-[#c18e2a] transition-colors uppercase tracking-widest"
                    >
                      Ver proyecto
                    </a>
                  </>
                ) : (
                  <span class="italic text-gray-400">...</span>
                )}
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
</article>

<style>
  /* --- Animaciones de Entrada --- */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .project-item.reveal {
    animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }

  /* --- Botones --- */
  .filter-btn.active .active-indicator {
    width: 100% !important;
    opacity: 1 !important;
    box-shadow: 0 0 15px #daa032;
  }

  nav {
    border-bottom: 1px solid rgba(218, 160, 50, 0.2);
  }

  /* Evitar saltos bruscos al filtrar */
  #project-grid {
    transition: opacity 0.3s ease;
  }
</style>

<script>
  function initFilters() {
    const buttons = document.querySelectorAll<HTMLButtonElement>(".filter-btn");
    const items = document.querySelectorAll<HTMLElement>(".project-item");

    // Función para aplicar el efecto de cascada
    const applyStagger = (filterValue: string) => {
      let visibleIndex = 0;
      items.forEach((item) => {
        const category = item.getAttribute("data-category");
        const shouldShow = filterValue === "all" || category === filterValue;

        if (shouldShow) {
          item.classList.remove("hidden");
          // Pequeño delay para que no aparezcan todos a la vez
          item.style.animationDelay = `${visibleIndex * 0.08}s`;
          item.classList.remove("reveal");
          void item.offsetWidth; // Force reflow
          item.classList.add("reveal");
          visibleIndex++;
        } else {
          item.classList.add("hidden");
        }
      });
    };

    // Inicialización
    const allBtn = document.querySelector<HTMLButtonElement>(
      '[data-filter="all"]'
    );
    if (allBtn) allBtn.classList.add("active");
    applyStagger("all");

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        if (button.classList.contains("active")) return;

        buttons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        const filter = button.getAttribute("data-filter") || "all";
        applyStagger(filter);
      });
    });
  }

  initFilters();
  document.addEventListener("astro:after-swap", initFilters);
</script>
