---
import ChatButton from './ChatButton.astro';
import ChatWindow from './ChatWindow.astro';

const cookies = Astro.request.headers.get("cookie") || "";
const lang = cookies.match(/preferredLang=([^;]+)/)?.[1] || "es";
const aiConsent = cookies.match(/cookie-consent-ai=([^;]+)/)?.[1];
const showChat = aiConsent !== "rejected";
---

{showChat && (
  /* Eliminamos inset-0 para que el contenedor no bloquee nada */
  <div id="chat-container" class="fixed bottom-0 right-0 sm:bottom-6 sm:right-6 z-[300] pointer-events-none">
    <div class="relative pointer-events-auto">
      <ChatButton />
      <ChatWindow lang={lang} />
    </div>
  </div>
)}

<script>
  function initChat() {
    const windowChat = document.getElementById('chat-window') as HTMLElement;
    if (!windowChat) return;

    const toggle = document.getElementById('chat-toggle');
    const header = document.getElementById('chat-header') as HTMLElement;
    const close = document.getElementById('close-chat');
    const input = document.getElementById('chat-input') as HTMLInputElement;
    const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
    const messagesContainer = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');

    // --- LÓGICA DE INTERFAZ (CORREGIDA) ---
    const toggleChat = () => {
      // Ahora usamos la clase is-active que configuramos en el CSS del ChatWindow
      windowChat.classList.toggle('is-active');
    };

    toggle?.addEventListener('click', toggleChat);
    close?.addEventListener('click', toggleChat);

    // --- LÓGICA DE ARRASTRE (Solo Desktop) ---
    let isDragging = false;
    let offsetX = 0, offsetY = 0;

    const startDrag = (e: MouseEvent | TouchEvent) => {
      if (window.innerWidth < 640) return; // No arrastrar en móvil
      isDragging = true;
      const clientX = 'touches' in e ? (e as TouchEvent).touches[0].clientX : (e as MouseEvent).clientX;
      const clientY = 'touches' in e ? (e as TouchEvent).touches[0].clientY : (e as MouseEvent).clientY;
      const rect = windowChat.getBoundingClientRect();
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;
    };

    const doDrag = (e: MouseEvent | TouchEvent) => {
      if (!isDragging) return;
      const clientX = 'touches' in e ? (e as TouchEvent).touches[0].clientX : (e as MouseEvent).clientX;
      const clientY = 'touches' in e ? (e as TouchEvent).touches[0].clientY : (e as MouseEvent).clientY;
      
      windowChat.style.left = `${clientX - offsetX}px`;
      windowChat.style.top = `${clientY - offsetY}px`;
      windowChat.style.bottom = 'auto';
      windowChat.style.right = 'auto';
    };

    header?.addEventListener('mousedown', startDrag);
    header?.addEventListener('touchstart', startDrag);
    document.addEventListener('mousemove', doDrag);
    document.addEventListener('touchmove', doDrag);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('touchend', () => isDragging = false);

    // --- LÓGICA DE MENSAJES (CON DISEÑO DORADO) ---
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      const currentLang = document.documentElement.lang || 'es';

      appendMessage('user', text);
      input.value = '';
      sendBtn.disabled = true;
      typingIndicator?.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          body: JSON.stringify({ message: text, language: currentLang }),
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        appendMessage('ai', data.text);
      } catch (e) {
        appendMessage('ai', currentLang === 'es' ? 'Error de conexión.' : 'Connection error.');
      } finally {
        typingIndicator?.classList.add('hidden');
        sendBtn.disabled = false;
      }
    }

    function appendMessage(role: 'user' | 'ai', text: string) {
      if (!messagesContainer) return;
      
      const div = document.createElement('div');
      div.className = role === 'user' ? 'user-bubble' : 'ai-bubble';
      
      // Estructura adaptada al nuevo diseño premium
      if (role === 'user') {
        div.innerHTML = `
          <div class="flex flex-col items-end">
            <span class="text-[9px] text-[#daa032] uppercase tracking-[2px] mb-1 mr-1 font-bold">Tú</span>
            <div class="msg-content">${text}</div>
          </div>
        `;
      } else {
        div.innerHTML = `
          <div class="flex items-center gap-2 mb-1.5 ml-1">
            <img src="/images/projects/ai/alterego/profile.webp" class="w-4 h-4 rounded-full border border-[#daa032]/30 object-cover" />
            <span class="text-[9px] text-[#daa032] uppercase tracking-[2px] opacity-70">Alter-Ego</span>
          </div>
          <div class="msg-content">${text}</div>
        `;
      }

      messagesContainer.appendChild(div);
      messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    }

    sendBtn?.addEventListener('click', sendMessage);
    input?.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
  }

  initChat();
  document.addEventListener("astro:after-swap", initChat);
</script>