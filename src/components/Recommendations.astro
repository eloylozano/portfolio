---
import RecommendationCard from "./RecommendationCard.astro";
import Title from "./Title.astro";
import { t } from "../i18n";

const lang =
  Astro.request.headers.get("cookie")?.match(/preferredLang=([^;]+)/)?.[1] ||
  "es";
---

<section
  id="recommendations"
  data-section="recommendations"
  aria-label="Recommendations section"
  class="scroll-container bg-[#161512] py-28 px-6 sm:px-12 md:px-24 lg:px-26 text-white overflow-hidden"
>
  <Title
    class="text-center mb-16 md:mb-32"
    text={t(lang, "pages.recomendations.title")}
  />

  <div
    class="flex flex-wrap justify-evenly gap-y-20 gap-x-20 lg:gap-10 max-w-8xl mx-auto mt-12 md:mt-32"
  >
    <RecommendationCard
      text={t(lang, "pages.recomendations.monica.text")}
      author="Mónica P. Sueiro"
      relationship={t(lang, "pages.recomendations.monica.relationship")}
      class="w-full md:w-[45%] reco-card opacity-0"
    />
    <RecommendationCard
      text={t(lang, "pages.recomendations.dani.text")}
      author="Dani Sánchez"
      relationship={t(lang, "pages.recomendations.dani.relationship")}
      class="w-full md:w-[45%] reco-card opacity-0"
    />
    <RecommendationCard
      text={t(lang, "pages.recomendations.miguel.text")}
      author="Miguel Iglesias"
      relationship={t(lang, "pages.recomendations.miguel.relationship")}
      class="w-full md:w-[90%] mx-auto reco-card opacity-0"
    />
  </div>
</section>

<style is:global>
  /* Usamos is:global para asegurar que afecte al componente hijo si no recibe las clases bien */
  .reco-card {
    transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    transform: translateY(30px);
  }

  .reco-card.visible {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  /* Efecto de brillo al pasar el ratón (opcional pero le da el toque) */
  .reco-card:hover {
    filter: brightness(1.1);
    box-shadow: 0 0 20px rgba(218, 160, 50, 0.1);
  }
</style>

<script>
  function setupRecomendations() {
    const cards = document.querySelectorAll(".reco-card");

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Buscamos el índice para el delay
            const allCards = Array.from(cards);
            const index = allCards.indexOf(entry.target as HTMLElement);

            (entry.target as HTMLElement).style.transitionDelay =
              `${index * 0.15}s`;
            entry.target.classList.add("visible");
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2 }
    );

    cards.forEach((card) => observer.observe(card));
  }

  document.addEventListener("astro:page-load", setupRecomendations);
  document.addEventListener("DOMContentLoaded", setupRecomendations);
</script>
