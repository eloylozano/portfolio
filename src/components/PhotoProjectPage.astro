---
import Subtitle from "./Subtitle.astro";
import Text from "./Text.astro";
import Title from "./Title.astro";
// import Lightbox from "./PopUp.astro";

const { title, description, coverImage, photos } = Astro.props;
---

<!-- Banner -->
<section class="w-full h-[30vh] overflow-hidden">
  <img src={coverImage} alt={title} class="object-cover w-full h-full" />
</section>

<!-- Title + Description -->
<section class="text-center my-12 max-w-6xl mx-auto px-4" id="projects">
  <Title text={title} />
  <div class="max-w-6xl mx-auto mt-4">
    <Text text={description} size="md" />
  </div>
</section>

<!-- Galería con columns (masonry) -->
<section class="w-full p-6 lg:px-26 mb-12">
  <h2 class="text-xl font-semibold text-[#daa032] mb-4">Galería</h2>
  <div id="gallery" class="columns-1 sm:columns-2 md:columns-4 gap-6 space-y-6">
    {
      photos.map((photo: any) => (
        <div class="break-inside-avoid overflow-hidden rounded-md shadow-md">
          <img
            src={photo.image}
            alt={photo.title}
            class="w-full h-auto rounded-md cursor-pointer transition-transform duration-300 hover:scale-105"
          />

          <meta itemprop="author" content="Eloy Lozano" />
          <meta itemprop="caption" content={photo.description} />

          <div class="bg-[#0b0b0b]/70 text-white p-4 text-xs italic space-y-1 mt-2 rounded-sm">
            <p class="text-[#e9eeef]">Distancia focal: {photo.tech.focal}</p>
            <p class="text-[#e9eeef]">Apertura: {photo.tech.aperture}</p>
            <p class="text-[#e9eeef]">ISO: {photo.tech.iso}</p>
            <p class="text-[#e9eeef]">Cámara: {photo.tech.camera}</p>
            <p class="text-[#e9eeef]">Lente: {photo.tech.lens}</p>
          </div>
        </div>
      ))
    }
  </div>
</section>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <span class="close-btn" id="lightbox-close">&times;</span>
  <img alt="Imagen ampliada" />
</div>

<style>
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    z-index: 50;
  }
  .lightbox.visible {
    display: flex;
  }
  .lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
  }
  .close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 2rem;
    cursor: pointer;
  }
</style>

<script>
  function initLightbox() {
    // Tipamos los elementos para que TS sepa que tienen propiedades como .src o .classList
    const lightbox = document.getElementById(
      "lightbox"
    ) as HTMLDivElement | null;
    const lightboxImg = lightbox?.querySelector(
      "img"
    ) as HTMLImageElement | null;
    const closeBtn = document.getElementById(
      "lightbox-close"
    ) as HTMLSpanElement | null;
    const gallery = document.getElementById("gallery") as HTMLDivElement | null;

    // Validación de seguridad
    if (!lightbox || !lightboxImg || !closeBtn || !gallery) return;

    gallery.addEventListener("click", (e: MouseEvent) => {
      // Forzamos a TS a entender que el click fue en una imagen
      const target = e.target as HTMLImageElement;

      if (target.tagName === "IMG") {
        lightboxImg.src = target.src;
        lightboxImg.alt = target.alt;
        lightbox.classList.add("visible");

        // Bloqueamos el scroll del body al abrir el lightbox
        document.body.style.overflow = "hidden";
      }
    });

    const close = () => {
      lightbox.classList.remove("visible");
      lightboxImg.src = "";
      // Restauramos el scroll
      document.body.style.overflow = "auto";
    };

    closeBtn.addEventListener("click", close);

    // Cerrar al hacer click fuera de la imagen
    lightbox.addEventListener("click", (e: MouseEvent) => {
      if (e.target === lightbox) close();
    });

    // Cerrar con la tecla Escape (muy bueno para UX)
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Escape" && lightbox.classList.contains("visible")) close();
    });
  }

  // Soporte para Astro View Transitions y carga normal
  document.addEventListener("astro:page-load", initLightbox);

  // Si no usas View Transitions, este evento asegura que funcione en el primer arranque
  if (!window.hasOwnProperty("astro")) {
    window.addEventListener("load", initLightbox);
  }
</script>
